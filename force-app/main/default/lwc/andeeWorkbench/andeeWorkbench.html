<template>

    <div data-id="mainDiv" class="slds-card-wrapper">

        
        <div class="spinner">
            <template if:true={isLoading}>
                <lightning-spinner alternative-text="Loading" variant="brand" size="large">
                </lightning-spinner>
            </template>
        </div>

        <br/>
        <div class="slds-media__body">

            <div class="slds-page-header slds-page-header_joined slds-page-header_bleed slds-shrink-none test-headerRegion slds-is-relative">
                <div class="slds-media slds-media--center slds-has-flexi-truncate">
                    <div class="slds-col slds-has-flexi-truncate firstHeaderRow">
                        <div class="slds-media slds-no-space slds-grow">
                            <h2 class="slds-card__header-title">
                                <span class="slds-truncate slds-m-right--xx-small" title="Workbench" onclick={zombieEasterEgg}>
                                    Workbench 1.0.7
                                </span>
                            </h2>
                        </div>
                    </div>
                </div>
            </div>

            <template if:true={error}>
                <div data-id="errorDiv">
                    <div data-id="errorDivInner" class="slds-notify slds-notify--alert slds-theme--error slds-theme--alert-texture" role="alert" >
                    {error}
                    </div>
                </div>
            </template>

            <template if:false={hideInfoDiv}>
                <div data-id="infoDiv" style="clear: both;">
                    <div class="slds-notify slds-notify--alert slds-theme--alert-texture" role="alert" >                        
                        <div class="closeInfoIcon">
                            <lightning-icon icon-name='utility:close' alternative-text='close' variant='inverse' size='xx-small' title='close' onclick={closeInfo}></lightning-icon>
                        </div>
                        Please note that all date/times are in UTC/GMT
                        <br/>
                        This is also an early release so where possible please double check the results
                    </div>
                </div>
            </template>

            <template if:true={isQueryMode}>
                <div>
                    <table border="0" style="width: 100%;">
                        <tbody>
                            <tr>
                                <td valign="top" width="1" style="margin-top:2em;">
                                    Object:<br/>
                                    <select data-id="objectSelect" id="objectSelect" style="width: 16em" onchange={objectChanged}>
                                        <template for:each={objectOptions} for:item="oo" for:index="index">
                                            <option key={oo.index} value={oo.value} selected={oo.selected}>{oo.label}</option>
                                        </template>
                                    </select>
                                </td>
                                <td>
                                    <table border="0" align="right" style="width:100%">
                                        <tbody>
                                            <tr>
                                                <td valign="top" colspan="2">&nbsp;
                                                </td>
                                                <td valign="top" colspan="2">
                                                    Deleted and archived records:<br>
                                                    <label>
                                                        <input type="radio" name="query_action" value="Query" checked>
                                                        Exclude
                                                    </label><br/>
                                                    <label>
                                                        <input type="radio" name="query_action" data-id="excludeDeleted" value="QueryAll">
                                                        Include
                                                    </label>
                                                </td>
                                                <td valign="top" align="left">
                                                    Date/time converter:<br>
                                                    <label>
                                                        <input type="radio" name="datetime_converter" value="local" data-id="localToUtc" onclick={datetimeChange}>
                                                        Local => UTC
                                                    </label><br/>
                                                    <label>
                                                        <input type="radio" name="datetime_converter" value="utc" checked onclick={datetimeChange}>
                                                        UTC => Local
                                                    </label><br/>
                                                    <input type="datetime-local" data-id="datetimeIn" name="datetime"  step="1" value={convertDateTime}/>
                                                    &nbsp;<input type="submit" name="querySubmit" value="=>" onclick={datetimeChange}/>&nbsp;
                                                    <label data-id="convertedDatetimeId"></label>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                                            
                            </tr>
                            <tr>
                                <td valign="top" width="1" style="margin-top:2em;">
                                    Fields:<br/>
                                    <select data-id="fieldSelect" id="fieldSelect" style="width: 16em;" multiple size="8" onchange={fieldChanged}>
                                        <option value='count()'>count()</option>
                                        <template for:each={fieldOptions} for:item="fo" for:index="index">
                                            <option key={fo.index} value={fo.value} selected={fo.selected}>{fo.label}</option>
                                        </template>
                                    </select>
                                </td>
                                <td>
                                    <table id="QB_right_sub_table" border="0" align="right" style="width:100%">
                                        <tbody data-id="sort_and_filter">
                                            <tr id="sort_selection_headers">
                                                <td colspan="2">
                                                    <br>Sort results by:
                                                </td> 
                                                <td>
                                                    <br>Max Records:
                                                </td>
                                            </tr>
                                        
                                            <tr id="sort_selection_row">
                                                <td colspan="2">
                                                    <select data-id="QB_orderby_field" name="QB_orderby_field" style="width: 16em;" onchange={orderChanged}>
                                                        <option value=""></option>                                                
                                                        <template for:each={fieldOptions} for:item="fo" for:index="index">
                                                            <option key={fo.index} value={fo.value}>{fo.label}</option>
                                                        </template>
                                                    </select>
                                                    <select data-id="QB_orderby_sort" name="QB_orderby_sort" style="width: 6em;" onchange={orderChanged}>
                                                        <option value="ASC">A to Z</option>
                                                        <option value="DESC">Z to A</option>
                                                    </select>
                                                    <select data-id="QB_nulls" name="QB_nulls" style="width: 10em;" onchange={orderChanged}>
                                                        <option value="FIRST" selected="selected">Nulls First</option>
                                                        <option value="LAST">Nulls Last</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="text" data-id="QB_limit_txt" size="10" name="QB_limit_txt" value={limit} onkeyup={limitChanged}>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <table data-id="filter_rows">
                                                        <tr>
                                                            <td colspan="4">
                                                                Filter results by:
                                                            </td>
                                                        </tr>

                                                        <tr data-id="filter-row-0">
                                                            <td colspan="4" valign="top" nowrap="true">
                                                                
                                                                <select data-id="QB_filter_field_0" name="QB_filter_field_0" style="width: 16em;" onchange={filterChanged}>
                                                                    <option value=""></option>                                                
                                                                    <template for:each={fieldWhereOptions} for:item="fo" for:index="index">
                                                                        <option key={fo.index} value={fo.value}>{fo.label}</option>
                                                                    </template>
                                                                </select>&nbsp;
                                                                <select data-id="QB_filter_compOper_0" name="QB_filter_compOper_0" style="width: 6em;" onchange={filterChanged}>
                                                                    <option value="=">=</option>
                                                                    <option value="!=">≠</option>
                                                                    <option value="<">&lt;</option>
                                                                    <option value="<=">≤</option>
                                                                    <option value=">">&gt;</option>
                                                                    <option value=">=">≥</option>
                                                                    <option value="starts">starts with</option>
                                                                    <option value="ends">ends with</option>
                                                                    <option value="contains">contains</option>
                                                                </select>
                                                                &nbsp;
                                                                <input type="text" data-id="QB_filter_value_0" size="27" name="QB_filter_value_0" value="" onkeyup={filterChanged}>
                                                            </td>
                                                        </tr>

                                                        <tr data-id="filter-row-1">
                                                            <td colspan="4" valign="top" nowrap="true">
                                                                
                                                                <select data-id="QB_filter_field_1" name="QB_filter_field_1" style="width: 16em;" onchange={filterChanged}>
                                                                    <option value=""></option>                                                
                                                                    <template for:each={fieldWhereOptions} for:item="fo" for:index="index">
                                                                        <option key={fo.index} value={fo.value}>{fo.label}</option>
                                                                    </template>
                                                                </select>&nbsp;
                                                                <select data-id="QB_filter_compOper_1" name="QB_filter_compOper_1" style="width: 6em;" onchange={filterChanged}>
                                                                    <option value="=">=</option>
                                                                    <option value="!=">≠</option>
                                                                    <option value="<">&lt;</option>
                                                                    <option value="<=">≤</option>
                                                                    <option value=">">&gt;</option>
                                                                    <option value=">=">≥</option>
                                                                    <option value="starts">starts with</option>
                                                                    <option value="ends">ends with</option>
                                                                    <option value="contains">contains</option>
                                                                </select>
                                                                &nbsp;
                                                                <input type="text" data-id="QB_filter_value_1" size="27" name="QB_filter_value_1" value="" onkeyup={filterChanged}>
                                                            </td>
                                                        </tr>

                                                        

                                                        <tr data-id="filter-row-2">
                                                            <td colspan="4" valign="top" nowrap="true">
                                                                
                                                                <select data-id="QB_filter_field_2" name="QB_filter_field_2" style="width: 16em;" onchange={filterChanged}>
                                                                    <option value=""></option>                                                
                                                                    <template for:each={fieldWhereOptions} for:item="fo" for:index="index">
                                                                        <option key={fo.index} value={fo.value}>{fo.label}</option>
                                                                    </template>
                                                                </select>&nbsp;
                                                                <select data-id="QB_filter_compOper_2" name="QB_filter_compOper_2" style="width: 6em;" onchange={filterChanged}>
                                                                    <option value="=">=</option>
                                                                    <option value="!=">≠</option>
                                                                    <option value="<">&lt;</option>
                                                                    <option value="<=">≤</option>
                                                                    <option value=">">&gt;</option>
                                                                    <option value=">=">≥</option>
                                                                    <option value="starts">starts with</option>
                                                                    <option value="ends">ends with</option>
                                                                    <option value="contains">contains</option>
                                                                </select>
                                                                &nbsp;
                                                                <input type="text" data-id="QB_filter_value_2" size="27" name="QB_filter_value_2" value="" onkeyup={filterChanged}>
                                                            </td>
                                                        </tr>

                                                        <tr data-id="filter-row-3">
                                                            <td colspan="4" valign="top" nowrap="true">
                                                                
                                                                <select data-id="QB_filter_field_3" name="QB_filter_field_3" style="width: 16em;" onchange={filterChanged}>
                                                                    <option value=""></option>                                                
                                                                    <template for:each={fieldWhereOptions} for:item="fo" for:index="index">
                                                                        <option key={fo.index} value={fo.value}>{fo.label}</option>
                                                                    </template>
                                                                </select>&nbsp;
                                                                <select data-id="QB_filter_compOper_3" name="QB_filter_compOper_3" style="width: 6em;" onchange={filterChanged}>
                                                                    <option value="=">=</option>
                                                                    <option value="!=">≠</option>
                                                                    <option value="<">&lt;</option>
                                                                    <option value="<=">≤</option>
                                                                    <option value=">">&gt;</option>
                                                                    <option value=">=">≥</option>
                                                                    <option value="starts">starts with</option>
                                                                    <option value="ends">ends with</option>
                                                                    <option value="contains">contains</option>
                                                                </select>
                                                                &nbsp;
                                                                <input type="text" data-id="QB_filter_value_3" size="27" name="QB_filter_value_3" value="" onkeyup={filterChanged}>
                                                            </td>
                                                        </tr>


                                                    </table>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>

                            <tr>
                                <td valign="top" colspan="2">
                                    <br>Enter or modify a SOQL query below:
                                    <br>
                                    <textarea data-id="soql_query_textarea" type="text" name="soql_query" rows="5" style="width: 99%; overflow: auto; font-family: monospace, courier;">
                                        {soqlQuery}
                                    </textarea>
                                </td>
                            </tr>

                            <tr>
                                <td colspan="1">
                                    <table>
                                        <tr>
                                            <td>
                                                <input type="submit" name="querySubmit" value="Query" onclick={submitQuery}>
                                            </td>
                                            <td>
                                                <input type="submit" name="querySubmitTsv" value="TSV" onclick={submitTsvQuery}>
                                            </td>
                                            <td>
                                                <input type="submit" name="querySubmitBatch" value="Batch TSV" onclick={submitQueryBatch}>
                                            </td>
                                            <td>
                                                <input type="submit" name="resync" value="Resync SOQL" onclick={resyncSoql} >
                                            </td>

                                            <template if:true={objectValue}>
                                                <td>
                                                    <input type="submit" name="querySubmit" value={insertButtonLabel} onclick={displayNewRowForInsert}>
                                                </td>
                                            </template>
                                        </tr>
                                    </table>                            
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!--<div style="clear: both;">-->
                <div class="scrollableContainer">
                    <br>
                    <template if:true={queryResults}>
                        <table id="query_results" class="scrollable">
                            <thead>
                                <tr>
                                    <template for:each={queryHeadings} for:item="qh" for:index="index">
                                        <th key={qh.index}>{qh}</th>
                                    </template>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={queryResults} for:item="record">
                                    <tr key={record.RowId} class="highlight-row">
                                    <template for:each={record.Fields} for:item="field">
                                        <td key={field.Name}>
                                            <template if:true={field.Linkable}>
                                                <template if:false={field.IsDownloadLink}>
                                                    <a data-id={field.Value} onclick={displaySingleRow}>{field.Value}</a>
                                                </template>
                                                <template if:true={field.IsDownloadLink}>
                                                    <a href={field.HRef} target="_blank">{field.Value}</a>
                                                </template>
                                            </template>
                                            <template if:false={field.Linkable}>
                                                {field.Value}
                                            </template>
                                        </td>
                                    </template>
                                    </tr>
                                </template>
        
                            </tbody>
                        </table>
                    </template>
        
                    <template if:true={jobStatus}>
                        <p>Status: {jobStatus.Status}</p>
                        <p>Items Processed: {jobStatus.JobItemsProcessed} / {jobStatus.TotalJobItems}</p>
                        
                        <template if:true={isBatchJobCompleted}>
                            <p><a href={contentVersionUrl} target="_blank">Download</a></p>
                        </template>
                    </template>
                </div>


            </template>

            

            <template if:true={isDisplaySingleId}>
                Single Id Display : {selectedSingleRecordId} for Object : {selectedSingleRecordObject}

                <p>
                    <input type="submit" name="back" value="Back" onclick={goBack}>
                    <input type="submit" name="update" value="Update" onclick={updateView}>
                    <template if:false={isUpdateView}>
                        <template if:false={isDeleted}>
                            <input type="submit" name="delete" value="Delete" onclick={deleteRow}>
                        </template>               
                        <template if:true={isDeleted}>
                            <input type="submit" name="undelete" value="Undelete" onclick={undeleteRow}>
                        </template>
                    </template>     
                </p>

                <table id="single_row_results" class="dataTable">
                    <tbody>
                        <template for:each={rowData} for:item="record">
                            <template if:false={isUpdateView}>
                                <tr key={record.Name} class="highlight-row">
                                    <td>
                                        <template if:true={record.Updatable}>
                                            <b>{record.Name}</b>
                                        </template>
                                        <template if:false={record.Updatable}>
                                            {record.Name}
                                        </template>
                                    </td>
                                    
                                    <td>
                                        <template if:true={record.Linkable}>
                                            <a data-id={record.Value} onclick={displaySingleRow}>{record.Value}</a>
                                        </template>
                                        <template if:false={record.Linkable}>
                                            {record.Value}
                                        </template>
                                    </td>
                                </tr>
                            </template>
                                
                            <template if:true={isUpdateView}>
                                <template if:true={record.Updatable}>
                                    <tr key={record.Name} class="highlight-row">
                                        <td>
                                            {record.Name}
                                        </td>
                                        <td style="border-color: white;">
                                            <input type="text" data-id="updateField" size="30" name="updateField" data-fieldname={record.Name} value={record.Value}/>
                                        </td>
                                    </tr>
                                </template>
                            </template>
                        </template>

                    </tbody>
                </table>


                <p>
                    <input type="submit" name="back" value="Back" onclick={goBack}>
                    <input type="submit" name="update" value="Update" onclick={updateView}>
                    <template if:false={isUpdateView}>
                        <template if:false={isDeleted}>
                            <input type="submit" name="delete" value="Delete" onclick={deleteRow}>
                        </template>               
                        <template if:true={isDeleted}>
                            <input type="submit" name="undelete" value="Undelete" onclick={undeleteRow}>
                        </template>
                    </template>
                </p>
            </template>

            

            

            <template if:true={isInsertView}>
                Object : {objectValue}

                <p>
                    <input type="submit" name="back" value="Back" onclick={goBack}>
                    <input type="submit" name="insert" value="Insert" onclick={insertRow}>
                </p>

                <table id="insert_row" class="dataTable">
                    <tbody>
                        <template for:each={fieldArrayCaseSensitive} for:item="record">
                            <template if:true={record.Updatable}>
                                <tr key={record.Name} class="highlight-row">
                                    <td>
                                        {record.Name}
                                    </td>
                                    <td style="border-color: white;">
                                        <input type="text" data-id={record.Name} size="30" name="updateField" data-fieldname={record.Name} value={record.Value}/>
                                    </td>
                                </tr>
                            </template>
                            <template if:false={record.Updatable}>
                                <template if:true={record.Createable}>
                                    <tr key={record.Name} class="highlight-row">
                                        <td>
                                            {record.Name}
                                        </td>
                                        <td style="border-color: white;">
                                            <input type="text" data-id={record.Name} size="30" name="updateField" data-fieldname={record.Name} value={record.Value}/>
                                        </td>
                                    </tr>
                                    </template>
                            </template>
                        </template>

                    </tbody>
                </table>


                <p>
                    <input type="submit" name="back" value="Back" onclick={goBack}>
                    <input type="submit" name="insert" value="Insert" onclick={insertRow}>
                </p>
            </template>


        </div>


        

    </div>
    
</template>