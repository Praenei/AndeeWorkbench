<template>

    <div data-id="mainDiv" class={mainDivClass}>

        <c-disable-back-button></c-disable-back-button>
        
        <template if:true={isLoading}>
            <div class="slds-spinner_container slds-is-fixed">            
                <lightning-spinner alternative-text="Loading" variant="brand" size="large">
                </lightning-spinner>            
            </div>
        </template>
        <br/>
        <div class="slds-media__body">

            <div class="slds-page-header slds-page-header_joined slds-page-header_bleed slds-shrink-none test-headerRegion slds-is-relative">
                <div class="slds-media slds-media--center slds-has-flexi-truncate">
                    <div class="slds-col slds-has-flexi-truncate firstHeaderRow">
                        <div class="slds-media slds-no-space slds-grow">
                            <h2 class="slds-card__header-title">
                                <span class="slds-truncate slds-m-right--xx-small" title="Workbench" onclick={zombieEasterEgg}>
                                    Workbench 1.8
                                </span>
                            </h2>
                        </div>
                    </div>
                </div>
            </div>

            <template if:false={hideInfoDiv}>
                <div data-id="infoDiv" style="clear: both;">
                    <div class="slds-notify slds-notify--alert slds-theme--alert-texture" role="alert" >                        
                        <div class="closeInfoIcon">
                            <lightning-icon icon-name='utility:close' alternative-text='close' variant='inverse' size='xx-small' title='close' onclick={closeInfo}></lightning-icon>
                        </div>
                        This is an early release so where possible please double check the results and report any issues to the dev.team
                    </div>
                </div>
            </template>

            <template if:true={isQueryMode}>
                <div>
                    <table border="0" style="width: 100%;">
                        <tbody>
                            <tr>
                                <td valign="top" width="1" style="margin-top:2em;">

                                    <lightning-input type="toggle" label="Show object labels" name="showObjectLabels" message-toggle-active='' message-toggle-inactive='' style="margin-top:5px; margin-bottom:5px;" checked={isShowObjectLabels} onchange={toggleShowObjectLabels}></lightning-input>

                                    Object:<br/>
                                    <select data-id="objectSelect" id="objectSelect" style="width: 30em" onchange={objectChanged}>
                                        <template for:each={objectOptions} for:item="oo" for:index="index">
                                            <option key={oo.value} value={oo.value} selected={oo.selected}>{oo.label}</option>
                                        </template>
                                    </select>
                                </td>
                                <td>
                                    <table border="0" align="right" style="width:100%">
                                        <tbody>
                                            <tr>
                                                <td valign="top" colspan="2">&nbsp;
                                                </td>
                                                <td valign="top" colspan="2">
                                                    Deleted and archived records:<br>
                                                    <label>
                                                        <input type="radio" name="query_action" value="Query" checked>
                                                        Exclude
                                                    </label><br/>
                                                    <label>
                                                        <input type="radio" name="query_action" data-id="excludeDeleted" value="QueryAll">
                                                        Include
                                                    </label>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                                            
                            </tr>
                            <tr>
                                <td valign="top" width="1" style="margin-top:2em;">
                                    Fields:<br/>
                                    <select data-id="fieldSelect" id="fieldSelect" style="width: 30em;" multiple size="15" onchange={fieldChanged}>
                                        <option value='count()'>count()</option>
                                        <template for:each={fieldOptions} for:item="fo" for:index="index">
                                            <option key={fo.key} value={fo.value} selected={fo.selected}>{fo.label}</option>
                                        </template>
                                    </select>
                                </td>
                                <td style="vertical-align: top; padding-left: 2em;">
                                    <table id="QB_right_sub_table" border="0" align="right" style="width:100%;">
                                        <tbody data-id="sort_and_filter">
                                            <tr id="sort_selection_headers">
                                                <td colspan="2">
                                                    <br>Sort results by:
                                                </td> 
                                                <td>
                                                    <br>Max Records:
                                                </td>
                                            </tr>
                                        
                                            <tr id="sort_selection_row">
                                                <td colspan="2">
                                                    <select data-id="QB_orderby_field" name="QB_orderby_field" style="width: 16em;" onchange={orderChanged}>
                                                        <option value=""></option>                                                
                                                        <template for:each={fieldOptions} for:item="fo" for:index="index">
                                                            <option key={fo.index} value={fo.value}>{fo.label}</option>
                                                        </template>
                                                    </select>
                                                    <select data-id="QB_orderby_sort" name="QB_orderby_sort" style="width: 6em;" onchange={orderChanged}>
                                                        <option value="ASC">A to Z</option>
                                                        <option value="DESC">Z to A</option>
                                                    </select>
                                                    <select data-id="QB_nulls" name="QB_nulls" style="width: 10em;" onchange={orderChanged}>
                                                        <option value="FIRST" selected="selected">Nulls First</option>
                                                        <option value="LAST">Nulls Last</option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <input type="text" data-id="QB_limit_txt" size="10" name="QB_limit_txt" value={limit} onkeyup={limitChanged}>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <table data-id="filter_rows">
                                                        <tr>
                                                            <td colspan="4">
                                                                Filter results by:
                                                            </td>
                                                        </tr>

                                                        <tr data-id="filter-row-0">
                                                            <td colspan="4" valign="top" nowrap="true">
                                                                
                                                                <select data-id="QB_filter_field_0" name="QB_filter_field_0" style="width: 16em;" onchange={filterChanged}>
                                                                    <option value=""></option>                                                
                                                                    <template for:each={fieldWhereOptions} for:item="fo" for:index="index">
                                                                        <option key={fo.index} value={fo.value}>{fo.label}</option>
                                                                    </template>
                                                                </select>&nbsp;
                                                                <select data-id="QB_filter_compOper_0" name="QB_filter_compOper_0" style="width: 6em;" onchange={filterChanged}>
                                                                    <option value="=">=</option>
                                                                    <option value="!=">≠</option>
                                                                    <option value="<">&lt;</option>
                                                                    <option value="<=">≤</option>
                                                                    <option value=">">&gt;</option>
                                                                    <option value=">=">≥</option>
                                                                    <option value="starts">starts with</option>
                                                                    <option value="ends">ends with</option>
                                                                    <option value="contains">contains</option>
                                                                </select>
                                                                &nbsp;
                                                                <input type="text" data-id="QB_filter_value_0" size="27" name="QB_filter_value_0" value="" onkeyup={filterChanged}>
                                                            </td>
                                                        </tr>

                                                        <tr data-id="filter-row-1">
                                                            <td colspan="4" valign="top" nowrap="true">
                                                                
                                                                <select data-id="QB_filter_field_1" name="QB_filter_field_1" style="width: 16em;" onchange={filterChanged}>
                                                                    <option value=""></option>                                                
                                                                    <template for:each={fieldWhereOptions} for:item="fo" for:index="index">
                                                                        <option key={fo.index} value={fo.value}>{fo.label}</option>
                                                                    </template>
                                                                </select>&nbsp;
                                                                <select data-id="QB_filter_compOper_1" name="QB_filter_compOper_1" style="width: 6em;" onchange={filterChanged}>
                                                                    <option value="=">=</option>
                                                                    <option value="!=">≠</option>
                                                                    <option value="<">&lt;</option>
                                                                    <option value="<=">≤</option>
                                                                    <option value=">">&gt;</option>
                                                                    <option value=">=">≥</option>
                                                                    <option value="starts">starts with</option>
                                                                    <option value="ends">ends with</option>
                                                                    <option value="contains">contains</option>
                                                                </select>
                                                                &nbsp;
                                                                <input type="text" data-id="QB_filter_value_1" size="27" name="QB_filter_value_1" value="" onkeyup={filterChanged}>
                                                            </td>
                                                        </tr>

                                                        

                                                        <tr data-id="filter-row-2">
                                                            <td colspan="4" valign="top" nowrap="true">
                                                                
                                                                <select data-id="QB_filter_field_2" name="QB_filter_field_2" style="width: 16em;" onchange={filterChanged}>
                                                                    <option value=""></option>                                                
                                                                    <template for:each={fieldWhereOptions} for:item="fo" for:index="index">
                                                                        <option key={fo.index} value={fo.value}>{fo.label}</option>
                                                                    </template>
                                                                </select>&nbsp;
                                                                <select data-id="QB_filter_compOper_2" name="QB_filter_compOper_2" style="width: 6em;" onchange={filterChanged}>
                                                                    <option value="=">=</option>
                                                                    <option value="!=">≠</option>
                                                                    <option value="<">&lt;</option>
                                                                    <option value="<=">≤</option>
                                                                    <option value=">">&gt;</option>
                                                                    <option value=">=">≥</option>
                                                                    <option value="starts">starts with</option>
                                                                    <option value="ends">ends with</option>
                                                                    <option value="contains">contains</option>
                                                                </select>
                                                                &nbsp;
                                                                <input type="text" data-id="QB_filter_value_2" size="27" name="QB_filter_value_2" value="" onkeyup={filterChanged}>
                                                            </td>
                                                        </tr>

                                                        <tr data-id="filter-row-3">
                                                            <td colspan="4" valign="top" nowrap="true">
                                                                
                                                                <select data-id="QB_filter_field_3" name="QB_filter_field_3" style="width: 16em;" onchange={filterChanged}>
                                                                    <option value=""></option>                                                
                                                                    <template for:each={fieldWhereOptions} for:item="fo" for:index="index">
                                                                        <option key={fo.index} value={fo.value}>{fo.label}</option>
                                                                    </template>
                                                                </select>&nbsp;
                                                                <select data-id="QB_filter_compOper_3" name="QB_filter_compOper_3" style="width: 6em;" onchange={filterChanged}>
                                                                    <option value="=">=</option>
                                                                    <option value="!=">≠</option>
                                                                    <option value="<">&lt;</option>
                                                                    <option value="<=">≤</option>
                                                                    <option value=">">&gt;</option>
                                                                    <option value=">=">≥</option>
                                                                    <option value="starts">starts with</option>
                                                                    <option value="ends">ends with</option>
                                                                    <option value="contains">contains</option>
                                                                </select>
                                                                &nbsp;
                                                                <input type="text" data-id="QB_filter_value_3" size="27" name="QB_filter_value_3" value="" onkeyup={filterChanged}>
                                                            </td>
                                                        </tr>


                                                    </table>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>

                            <tr>
                                <td valign="top" colspan="2">
                                    <br>Enter or modify a SOQL query below:
                                    <br>
                                    <textarea data-id="soql_query_textarea" type="text" name="soql_query" rows="5" style="width: 99%; overflow: auto; font-family: monospace, courier;">
                                        {soqlQuery}
                                    </textarea>
                                </td>
                                
                                <td style="vertical-align: middle; padding-left: 10px;">
                                    <div style="display: flex; flex-direction: column; justify-content: center; height: 100%;">
                                        {querySaveDisplayPosition}/{querySaveTotal}<br/>
                                        <lightning-button-icon icon-name='utility:arrowup' alternative-text='forward' size='x-small' title='forward' disabled={historyUpDisabled} onclick={historyUp} style="margin-bottom: 5px;"></lightning-button-icon>
                                        <lightning-button-icon icon-name='utility:arrowdown' alternative-text='back' size='x-small' title='back' disabled={historyDownDisabled} onclick={historyDown}></lightning-button-icon>
                                    </div>
                                </td>
                            </tr>                            

                            <template if:true={error}>
                                <tr>
                                    <td colspan="3">
                                    <div data-id="errorDiv">
                                        <div data-id="errorDivInner" class="slds-notify slds-notify--alert slds-theme--error slds-theme--alert-texture" role="alert" >
                                        {error}
                                        </div>
                                    </div>
                                    </td>
                                </tr>
                            </template>
                            <tr>
                                <td colspan="3" style="padding-top: 5px; padding-bottom: 5px;" >
                                    <lightning-button
                                        type="submit"
                                        label="Query"
                                        class="slds-m-top_small"
                                        onclick={submitQuery}
                                        style="margin-right: 10px;"
                                    ></lightning-button>
                                    
                                    <lightning-button
                                        type="submit"
                                        label="TSV"
                                        class="slds-m-top_small"
                                        onclick={submitTsvQuery}
                                        style="margin-right: 10px;"
                                    ></lightning-button>
                                    
                                    <lightning-button
                                        type="submit"
                                        label="Batch TSV"
                                        class="slds-m-top_small"
                                        onclick={submitQueryBatch}
                                        style="margin-right: 10px;"
                                    ></lightning-button>

                                    <template if:true={objectValue}>
                                    
                                        <lightning-button
                                            type="submit"
                                            label="Resync Query Fields"
                                            class="slds-m-top_small"
                                            onclick={resyncSoqlFields}
                                            style="margin-right: 10px;"
                                        ></lightning-button>
                                        
                                        <lightning-button
                                            type="submit"
                                            label="Resync Query Object"
                                            class="slds-m-top_small"
                                            onclick={resyncSoqlObject}
                                            style="margin-right: 10px;"
                                        ></lightning-button>

                                        <lightning-button
                                            type="submit"
                                            label={insertButtonLabel}
                                            class="slds-m-top_small"
                                            onclick={displayNewRowForInsert}
                                            style="margin-right: 10px;"
                                        ></lightning-button>
                                    </template>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>



                <!--Query Results-->
            
                <br>
    
                <template if:true={jobStatus}>
                    <p>Status: {jobStatus.Status}</p>
                    <p>Items Processed: {jobStatus.JobItemsProcessed} / {jobStatus.TotalJobItems}</p>
                    
                    <template if:true={isBatchJobCompleted}>
                        <p><a href={contentVersionUrl} target="_blank">Download</a></p>
                    </template>
                </template>
                
                <template if:true={queryResults}>

                    <template if:true={totalRowCountWithNoLimit}>
                        Total rows : <lightning-formatted-number value={totalRowCountWithNoLimit}> </lightning-formatted-number>
                        <template if:true={displayOffsetDetails}>
                            &NonBreakingSpace;(showing : <lightning-formatted-number value={displayStartingDataRowNumber}> </lightning-formatted-number> - <lightning-formatted-number value={displayLastDataRowNumber}> </lightning-formatted-number>)
                        </template>
                        <br>
                    </template>

                    <div class="scrollableContainer">
                        <table id="query_results" class="scrollable">
                            <thead>
                                <tr>
                                    <template for:each={queryHeadings} for:item="qh" for:index="index">
                                        <th key={qh.index} onclick={queryHeadingClick} data-heading={qh.name}>{qh.name}
                                            <template if:true={qh.isPrimarySort}>
                                                <template if:true={qh.isPrimarySortOrderAsc}>
                                                    <lightning-icon icon-name="utility:arrowup" size="xx-small" class="slds-m-left_x-small"></lightning-icon>
                                                </template>
                                                <template if:false={qh.isPrimarySortOrderAsc}>
                                                    <lightning-icon icon-name="utility:arrowdown" size="xx-small" class="slds-m-left_x-small"></lightning-icon>
                                                </template>
                                            </template>
                                        </th>
                                    </template>
                                </tr>
                            </thead>
                            <tbody>
                                <template for:each={queryResults} for:item="record">
                                    <tr key={record.RowId} class="highlight-row">
                                    <template for:each={record.Fields} for:item="field">
                                        <td key={field.Name}>
                                            <template if:true={field.Linkable}>
                                                <template if:false={field.IsDownloadLink}>
                                                    <div class="link-preview-container">
                                                        <a data-id={field.Value} onclick={displaySingleRow}>{field.Value}</a>
                                                        <template if:true={field.HRef}>
                                                            <div key={field.Value} class="preview-icon-container" onclick={previewClick} data-id={field.HRef}>
                                                                <lightning-icon icon-name='utility:preview' alternative-text='preview' size='xx-small' title='preview'></lightning-icon>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>
                                                <template if:true={field.IsDownloadLink}>
                                                    <a href={field.HRef} target="_blank">{field.Value}</a> <lightning-icon icon-name="utility:download" size="xx-small" class="slds-m-left_x-small"></lightning-icon></a>
                                                </template>
                                            </template>
                                            <template if:false={field.Linkable}>
                                                {field.Value}
                                            </template>
                                        </td>
                                    </template>
                                    </tr>
                                </template>
        
                            </tbody>
                        </table>
                    </div>

                    <div style="padding-top: 5px;">
                        <template if:true={prevDataToShow}>
                            <lightning-button
                                type="submit"
                                label="Previous"
                                class="slds-m-top_small"
                                onclick={loadPreviousPageOfData}
                                style="padding-top: 5px; margin-right: 10px;"
                            ></lightning-button>
                        </template>
    
                        <template if:true={moreDataToShow}>
                            <lightning-button
                                type="submit"
                                label="More"
                                class="slds-m-top_small"
                                onclick={loadNextPageOfData}
                                style="padding-top: 5px; margin-right: 10px;"
                            ></lightning-button>
                        </template>

                    </div>
                </template>
            


            </template>

            
            <!-- Display single record for view or update -->
            <template if:true={isDisplaySingleId}>
                <div class="slds-text-heading_small" style="padding: 10px;">
                    Single Id Display : {selectedSingleRecordId} for Object : {selectedSingleRecordObject}
                </div>
                <template if:false={isUpdateView}>

                    <template if:true={error}>

                        <div data-id="errorDiv">
                            <div data-id="errorDivUpdate" class="slds-notify slds-notify--alert slds-theme--error slds-theme--alert-texture" role="alert" >
                            {error}
                            </div>
                        </div>

                    </template>
                    <div class="bottom-right-container2">
                        <lightning-input type="toggle" label="Show field labels" name="showFieldLabels" class="bottom-right-container2" message-toggle-active='' message-toggle-inactive='' style="margin-top:5px; margin-bottom:5px;" checked={isShowFieldLabels} onchange={toggleShowFieldLabels}></lightning-input>
                    </div>
                    
                    <div class="bottom-right-container">
                        <p>
                            <lightning-button
                                type="submit"
                                label="Back"
                                class="slds-m-top_small"
                                onclick={goBack}
                                style="margin-right: 10px;"
                            ></lightning-button>
                            <lightning-button
                                type="submit"
                                label="Update"
                                class="slds-m-top_small"
                                onclick={displayUpdateView}
                                style="margin-right: 10px;"
                            ></lightning-button>

                            
                            <template if:false={isUpdateView}>
                                <lightning-button
                                    type="submit"
                                    label="Clone"
                                    class="slds-m-top_small"
                                    onclick={cloneRow}
                                    style="margin-right: 10px;"
                                ></lightning-button>

                                <template if:false={isDeleted}>
                                    <lightning-button
                                        type="submit"
                                        label="Delete"
                                        class="slds-m-top_small"
                                        onclick={deleteRow}
                                        style="margin-right: 10px;"
                                    ></lightning-button>
                                </template>               
                                <template if:true={isDeleted}>
                                    <lightning-button
                                        type="submit"
                                        label="Undelete"
                                        class="slds-m-top_small"
                                        onclick={undeleteRow}
                                        style="margin-right: 10px;"
                                    ></lightning-button>
                                </template>
                            </template>     
                        </p>
                    </div>
                </template>

                <table id="single_row_results" class="dataTable" style="width:80%">
                    <tbody>
                        <template for:each={styledRowData} for:item="record">
                            <template if:false={isUpdateView}>
                                <tr key={record.Name} class="highlight-row">
                                    <template if:false={isShowFieldLabels}>
                                        <td style={record.nameStyle} title={record.Label}>
                                            {record.Name}
                                        </td>
                                    </template>
                                    <template if:true={isShowFieldLabels}>
                                        <td style={record.nameStyle} title={record.Name}>
                                            {record.Label}
                                        </td>
                                    </template>

                                    
                                    <td>
                                        <template if:true={record.Linkable}>
                                            <a data-id={record.Value} onclick={displaySingleRow}>{record.Value}</a>
                                        </template>
                                        <template if:false={record.Linkable}>
                                            {record.Value}
                                        </template>
                                    </td>
                                </tr>
                            </template>
                                
                            <template if:true={isUpdateView}>
                                <template if:true={record.Updatable}>
                                    <tr key={record.Name} class="highlight-row">
                                        <td style={record.nameStyle} title={record.Label}>
                                            {record.Name}
                                        </td>
                                        <td style="border-color: white;">
                                            <input type="text" data-id="updateField" size="30" name="updateField" data-fieldname={record.Name} value={record.Value}/>
                                        </td>
                                    </tr>
                                </template>
                            </template>
                        </template>

                    </tbody>
                </table>

                <template if:true={isUpdateView}>
                    <div class="bottom-right-container">
                    <p>
                        <lightning-button
                            type="submit"
                            label="Back"
                            class="slds-m-top_small"
                            onclick={goBack}
                            style="margin-right: 10px;"
                        ></lightning-button>
                        <lightning-button
                            type="submit"
                            label="Save"
                            class="slds-m-top_small"
                            onclick={updateRow}
                            style="margin-right: 10px;"
                        ></lightning-button>
                    </p>
                    
                    </div>
                </template>
            </template>

            

            

            <template if:true={isInsertView}>
                <div class="slds-text-heading_small" style="padding: 10px;">
                    Object : {objectValue}
                </div>  

                <template if:true={error}>
                    <div data-id="errorDiv">
                        <div data-id="errorDivInsert" class="slds-notify slds-notify--alert slds-theme--error slds-theme--alert-texture" role="alert" >
                        {error}
                        </div>
                    </div>
                </template>
                
                <table id="insert_row" class="dataTable">
                    <tbody>
                        <template for:each={styledFieldArrayCaseSensitive} for:item="record">
                            <template if:true={record.Updatable}>
                                <tr key={record.Name} class="highlight-row">
                                    <td style={record.nameStyle} title={record.Label}>
                                        {record.Name}
                                    </td>
                                    <td style="border-color: white;">
                                        <input type="text" data-id={record.Name} size="30" name="insertField" data-fieldname={record.Name} value={record.Value}/>
                                    </td>
                                </tr>
                            </template>
                            <template if:false={record.Updatable}>
                                <template if:true={record.Createable}>
                                    <tr key={record.Name} class="highlight-row">
                                        <td style={record.nameStyle} title={record.Label}>
                                            {record.Name}
                                        </td>
                                        <td style="border-color: white;">
                                            <input type="text" data-id={record.Name} size="30" name="updateField" data-fieldname={record.Name} value={record.Value}/>
                                        </td>
                                    </tr>
                                    </template>
                            </template>
                        </template>

                    </tbody>
                </table>

                <div class="bottom-right-container">
                    <p>
                        <lightning-button
                            type="submit"
                            label="Back"
                            class="slds-m-top_small"
                            onclick={goBack}
                            style="margin-right: 10px;"
                        ></lightning-button>
                        
                        <lightning-button
                            type="submit"
                            label="Save"
                            class="slds-m-top_small"
                            onclick={insertRow}
                            style="margin-right: 10px;"
                        ></lightning-button>
                    </p>
                </div>
            </template>

        </div>
        
    </div>
    
</template>